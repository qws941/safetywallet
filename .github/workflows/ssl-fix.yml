name: SSL Diagnostic & Fix
on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action to take"
        required: true
        default: "diagnose"
        type: choice
        options:
          - diagnose
          - fix-total-tls
          - fix-advanced-cert
          - redeploy-worker

jobs:
  ssl-fix:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    env:
      CF_API: https://api.cloudflare.com/client/v4
    steps:
      - uses: actions/checkout@v4

      - name: Get Zone ID
        id: zone
        run: |
          ZONE_RESP=$(curl -sS "$CF_API/zones?name=jclee.me" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json")

          echo "=== Zone Response ==="
          echo "$ZONE_RESP" | jq '.'

          ZONE_ID=$(echo "$ZONE_RESP" | jq -r '.result[0].id // empty')
          if [ -z "$ZONE_ID" ]; then
            echo "::error::Failed to get zone ID for jclee.me"
            exit 1
          fi
          echo "zone_id=$ZONE_ID" >> "$GITHUB_OUTPUT"
          echo "✅ Zone ID: $ZONE_ID"

      - name: Diagnose SSL
        if: inputs.action == 'diagnose'
        run: |
          ZONE_ID="${{ steps.zone.outputs.zone_id }}"

          echo "=== 1. Custom Domains (Workers) ==="
          curl -sS "$CF_API/accounts/${{ vars.CLOUDFLARE_ACCOUNT_ID || 'a8d9c67f586acdd15eebcc65ca3aa5bb' }}/workers/domains" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.'

          echo ""
          echo "=== 2. SSL Certificate Packs ==="
          curl -sS "$CF_API/zones/$ZONE_ID/ssl/certificate_packs?status=all" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.result[] | {id, type, status, hosts: .certificates[0].hosts}'

          echo ""
          echo "=== 3. SSL/TLS Settings ==="
          curl -sS "$CF_API/zones/$ZONE_ID/settings/ssl" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.'

          echo ""
          echo "=== 4. Total TLS Status ==="
          curl -sS "$CF_API/zones/$ZONE_ID/acm/total_tls" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.'

          echo ""
          echo "=== 5. Custom Hostnames ==="
          curl -sS "$CF_API/zones/$ZONE_ID/custom_hostnames?hostname=admin.safetywallet.jclee.me" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.'

          echo ""
          echo "=== 6. DNS Records for safetywallet ==="
          curl -sS "$CF_API/zones/$ZONE_ID/dns_records?name=admin.safetywallet.jclee.me" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.'

          echo ""
          echo "=== 7. Worker Routes ==="
          curl -sS "$CF_API/zones/$ZONE_ID/workers/routes" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.'

          echo ""
          echo "=== 8. Worker Custom Domains (v2) ==="
          curl -sS "$CF_API/zones/$ZONE_ID/workers/domains" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.' 2>/dev/null || echo "Endpoint not available at zone level"

          echo ""
          echo "=== 9. SSL Verification for admin subdomain ==="
          curl -sS "$CF_API/zones/$ZONE_ID/ssl/verification?hostname=admin.safetywallet.jclee.me" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" | jq '.' 2>/dev/null || echo "N/A"

          echo ""
          echo "=== 10. Live TLS Check ==="
          curl -sS -o /dev/null -w "HTTP: %{http_code}\nSSL_VERIFY: %{ssl_verify_result}\n" \
            --connect-timeout 5 --max-time 10 \
            https://admin.safetywallet.jclee.me 2>&1 || echo "Connection failed (expected)"

          echo ""
          echo "=== 11. Main domain TLS Check ==="
          curl -sS -o /dev/null -w "HTTP: %{http_code}\nSSL_VERIFY: %{ssl_verify_result}\n" \
            --connect-timeout 5 --max-time 10 \
            https://safetywallet.jclee.me

      - name: Enable Total TLS
        if: inputs.action == 'fix-total-tls'
        run: |
          ZONE_ID="${{ steps.zone.outputs.zone_id }}"

          echo "=== Enabling Total TLS with Let's Encrypt ==="
          RESP=$(curl -sS -X PATCH "$CF_API/zones/$ZONE_ID/acm/total_tls" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"enabled": true, "certificate_authority": "lets_encrypt"}')

          echo "$RESP" | jq '.'
          SUCCESS=$(echo "$RESP" | jq -r '.success')

          if [ "$SUCCESS" = "true" ]; then
            echo "✅ Total TLS enabled. Certificates will be auto-provisioned for all subdomains."
            echo "⏳ Wait 2-5 minutes for certificate issuance."
          else
            echo "::error::Failed to enable Total TLS"
            echo "$RESP" | jq '.errors'
            exit 1
          fi

      - name: Order Advanced Certificate
        if: inputs.action == 'fix-advanced-cert'
        run: |
          ZONE_ID="${{ steps.zone.outputs.zone_id }}"

          echo "=== Ordering Advanced Certificate ==="
          RESP=$(curl -sS -X POST "$CF_API/zones/$ZONE_ID/ssl/certificate_packs/order" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "type": "advanced",
              "hosts": [
                "safetywallet.jclee.me",
                "*.safetywallet.jclee.me"
              ],
              "validation_method": "txt",
              "validity_days": 90,
              "certificate_authority": "lets_encrypt"
            }')

          echo "$RESP" | jq '.'
          SUCCESS=$(echo "$RESP" | jq -r '.success')

          if [ "$SUCCESS" = "true" ]; then
            echo "✅ Advanced certificate ordered for *.safetywallet.jclee.me"
            echo "⏳ Certificate will be issued within minutes via DCV."
          else
            echo "::error::Failed to order Advanced Certificate"
            echo "$RESP" | jq '.errors'
            exit 1
          fi

      - name: Redeploy Worker
        if: inputs.action == 'redeploy-worker'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          workingDirectory: apps/api-worker
          command: deploy --dry-run=false
