# SSoT: qws941/.github — synced via BetaHuhn/repo-file-sync-action
name: E2E Failure Issue

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

concurrency:
  group: e2e-auto-issue-${{ github.event.workflow_run.id }}
  cancel-in-progress: false

permissions:
  issues: write
  actions: read

jobs:
  create-issue:
    name: Create E2E Failure Issue
    runs-on: ubuntu-latest
    if: >-
      github.event.workflow_run.conclusion == 'failure'
      && github.event.workflow_run.event == 'push'
    steps:
      - name: Check E2E job result
        id: check
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const { data } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.payload.workflow_run.id,
            });
            const e2eJob = data.jobs.find(j => j.name === 'E2E Tests');
            if (!e2eJob || e2eJob.conclusion !== 'failure') {
              core.info('E2E job did not fail — skipping');
              core.setOutput('failed', 'false');
              return;
            }
            core.setOutput('failed', 'true');
            core.setOutput('job_url', e2eJob.html_url);

      - name: Check for existing open issue
        if: steps.check.outputs.failed == 'true'
        id: dedup
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'e2e-failure',
              state: 'open',
              per_page: 1,
            });
            if (issues.length > 0) {
              const run = context.payload.workflow_run;
              const sha = run.head_sha.slice(0, 7);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `E2E failed again on [\`${sha}\`](${run.html_url}) — ${run.head_commit?.message?.split('\\n')[0] || 'no message'}`,
              });
              core.info(`Commented on existing issue #${issues[0].number}`);
              core.setOutput('exists', 'true');
            } else {
              core.setOutput('exists', 'false');
            }

      - name: Create issue
        if: steps.check.outputs.failed == 'true' && steps.dedup.outputs.exists == 'false'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const run = context.payload.workflow_run;
            const sha = run.head_sha.slice(0, 7);
            const commitMsg = run.head_commit?.message?.split('\n')[0] || 'unknown';
            const runUrl = run.html_url;
            const jobUrl = '${{ steps.check.outputs.job_url }}';

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `E2E failure on ${run.head_branch} (${sha})`,
              labels: ['e2e-failure', 'type:bug', 'priority:high'],
              body: [
                '## E2E Test Failure',
                '',
                '| Field | Value |',
                '|-------|-------|',
                `| **Commit** | [\`${sha}\`](https://github.com/${context.repo.owner}/${context.repo.repo}/commit/${run.head_sha}) |`,
                `| **Branch** | \`${run.head_branch}\` |`,
                `| **Message** | ${commitMsg} |`,
                `| **Run** | [View workflow run](${runUrl}) |`,
                `| **E2E Job** | [View job](${jobUrl}) |`,
                `| **Actor** | @${run.actor?.login || 'unknown'} |`,
                '',
                '### Next Steps',
                `1. Download the [Playwright report artifact](${runUrl}) for failure details`,
                '2. Reproduce locally: `npm run test:e2e:smoke`',
                '3. Fix and close this issue',
              ].join('\n'),
            });
