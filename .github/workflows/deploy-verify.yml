name: Deploy Verification

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        default: "production"
      ref:
        required: true
        type: string

env:
  NODE_VERSION: "20"

jobs:
  verify:
    name: Smoke Test (${{ inputs.environment }})
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          ref: ${{ inputs.ref }}

      - uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Get Playwright version
        id: pw-version
        run: echo "version=$(npx playwright --version)" >> "$GITHUB_OUTPUT"
        working-directory: e2e

      - name: Cache Playwright browsers
        id: pw-cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.pw-version.outputs.version }}

      - name: Install Playwright browsers
        if: steps.pw-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps
        working-directory: e2e

      - name: Install Playwright system deps
        if: steps.pw-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium
        working-directory: e2e

      - name: Set environment URLs
        id: urls
        run: |
          if [ "${{ inputs.environment }}" = "staging" ]; then
            echo "worker_url=https://safetywallet-dev.jclee.workers.dev" >> "$GITHUB_OUTPUT"
            echo "admin_url=https://safetywallet-dev.jclee.workers.dev/admin" >> "$GITHUB_OUTPUT"
            echo "api_url=https://safetywallet-dev.jclee.workers.dev/api" >> "$GITHUB_OUTPUT"
          else
            echo "worker_url=https://safetywallet.jclee.me" >> "$GITHUB_OUTPUT"
            echo "admin_url=https://safetywallet.jclee.me/admin" >> "$GITHUB_OUTPUT"
            echo "api_url=https://safetywallet.jclee.workers.dev/api" >> "$GITHUB_OUTPUT"
          fi

      - name: Run smoke tests
        run: npx playwright test --grep @smoke --project=api
        env:
          CI: "true"
          WORKER_APP_URL: ${{ steps.urls.outputs.worker_url }}
          ADMIN_APP_URL: ${{ steps.urls.outputs.admin_url }}
          API_URL: ${{ steps.urls.outputs.api_url }}

      - name: Upload Playwright report
        if: failure()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: playwright-report-${{ inputs.environment }}
          path: e2e/playwright-report/
          retention-days: 7

  notify-slack:
    name: Notify Slack
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: verify
    if: always() && !cancelled()
    steps:
      - name: Send verify status to Slack (optional)
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || secrets.DEPLOY_MONITOR_WEBHOOK_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ENVIRONMENT: ${{ inputs.environment }}
          VERIFY_RESULT: ${{ needs.verify.result }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "Slack webhook not configured. Skipping notification."
            exit 0
          fi

          status="SUCCESS"
          icon=":white_check_mark:"
          color="#2eb886"
          if [ "$VERIFY_RESULT" = "failure" ]; then
            status="FAILED"
            icon=":x:"
            color="#d40e0d"
          elif [ "$VERIFY_RESULT" = "cancelled" ]; then
            status="CANCELLED"
            icon=":warning:"
            color="#daa038"
          elif [ "$VERIFY_RESULT" = "skipped" ]; then
            status="SKIPPED"
            icon=":warning:"
            color="#daa038"
          fi

          payload=$(printf '{"attachments":[{"color":"%s","text":"%s Deploy verification (%s) %s\\n- Smoke test: %s\\n- Run: %s"}]}' \
            "$color" "$icon" "$ENVIRONMENT" "$status" "$VERIFY_RESULT" "$RUN_URL")

          if ! curl -sS --fail-with-body --retry 3 --retry-all-errors --retry-delay 2 --max-time 30 -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$payload"; then
            echo "::warning::Failed to deliver verify Slack notification"
          fi
