name = "safetywallet"
main = "apps/api/src/index.ts"
compatibility_date = "2024-12-30"
compatibility_flags = ["nodejs_compat_v2"]
workers_dev = true

# Custom domain routes (requires Zone permissions in API token)
routes = [
  { pattern = "safetywallet.jclee.me/*", zone_name = "jclee.me" },
  { pattern = "admin.safetywallet.jclee.me", custom_domain = true },
]

[vars]
ENVIRONMENT = "production"
REQUIRE_ATTENDANCE_FOR_LOGIN = "false"
REQUIRE_ATTENDANCE_FOR_POST = "false"
ELASTICSEARCH_INDEX_PREFIX = "safetywallet-logs"
ALLOWED_ORIGINS = "https://safetywallet.jclee.me,https://admin.safetywallet.jclee.me"
VAPID_SUBJECT = "mailto:admin@safetywallet.jclee.me"
FAS_DB_NAME = "mdidev"
FAS_SITE_CD = "10"
FAS_SITE_NAME = "송도세브란스"

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "safetywallet-db"
database_id = "45065dd5-1f89-4a1b-9e13-228594f309ce"

# Workers Static Assets configuration
[assets]
directory = "dist"
binding = "ASSETS"
not_found_handling = "none"
run_worker_first = true

# R2 Bucket for images
[[r2_buckets]]
binding = "R2"
bucket_name = "safetywallet-images"

# R2 Bucket for AceTime data (photos + DB from NAS)
[[r2_buckets]]
binding = "ACETIME_BUCKET"
bucket_name = "safewallet-acetime"

# Hyperdrive — FAS MariaDB (AceTime direct connection)
[[hyperdrive]]
binding = "FAS_HYPERDRIVE"
id = "83c32c884d3b42b18c4b0601c0e2e0dc"
localConnectionString = "postgresql://root:root@localhost:5432/fas_local"

# KV Namespace for cache/sessions
[[kv_namespaces]]
binding = "KV"
id = "57ab28dca9dd4193a8f59f93e57122d8"

# Analytics Engine for observability
[[analytics_engine_datasets]]
binding = "ANALYTICS"

# Cloudflare Queue for reliable notification delivery
[[queues.producers]]
queue = "safetywallet-notifications"
binding = "NOTIFICATION_QUEUE"

[[queues.consumers]]
queue = "safetywallet-notifications"
max_batch_size = 10
max_batch_timeout = 5
max_retries = 3
dead_letter_queue = "safetywallet-notifications-dlq"

# Workers AI for hazard classification and privacy features
[ai]
binding = "AI"

# Workers Logs observability
[observability]
enabled = true
head_sampling_rate = 1

# Durable Objects for rate limiting
[durable_objects]
bindings = [{ name = "RATE_LIMITER", class_name = "RateLimiter" }]

[[migrations]]
tag = "v1"
new_sqlite_classes = ["RateLimiter"]
