"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[189],{189:function(t,e,n){n.d(e,{E6:function(){return m},Kb:function(){return f},LR:function(){return d},NH:function(){return c},PQ:function(){return S},Pe:function(){return b},S5:function(){return h},Vi:function(){return y},Y7:function(){return p},Zf:function(){return O},_H:function(){return I},cl:function(){return l},f_:function(){return u},g6:function(){return N},hT:function(){return R},m7:function(){return v},qQ:function(){return E}});var i=n(1988),s=n(7930),r=n(5969),o=n(5118),a=n(8144);function u(){let t=(0,a.t)(t=>t.currentSiteId);return(0,i.a)({queryKey:["dashboard","stats",t],queryFn:()=>(0,o.S)("/sites/".concat(t,"/stats")),enabled:!!t})}function c(t){let e=(0,a.t)(t=>t.currentSiteId),n=new URLSearchParams;return e&&n.set("siteId",e),t&&n.set("status",t),(0,i.a)({queryKey:["admin","posts",e,t],queryFn:()=>(0,o.S)("/posts?".concat(n.toString())),enabled:!!e})}function h(t){return(0,i.a)({queryKey:["admin","post",t],queryFn:()=>(0,o.S)("/posts/".concat(t)),enabled:!!t})}function l(){let t=(0,s.NL)();return(0,r.D)({mutationFn:t=>{let{postId:e,action:n,reason:i,note:s}=t;return(0,o.S)("/reviews",{method:"POST",body:JSON.stringify({postId:e,action:n,reason:i,note:s})})},onSuccess:()=>{t.invalidateQueries({queryKey:["admin","posts"]}),t.invalidateQueries({queryKey:["dashboard"]})}})}function d(t){let e=(0,a.t)(t=>t.currentSiteId),n=t||e;return(0,i.a)({queryKey:["admin","members",n],queryFn:()=>(0,o.S)("/sites/".concat(n,"/members")),enabled:!!n})}function f(t){let e=(0,a.t)(t=>t.currentSiteId);return(0,i.a)({queryKey:["admin","member",e,t],queryFn:()=>(0,o.S)("/sites/".concat(e,"/members/").concat(t)),enabled:!!e&&!!t})}function m(){let t=(0,a.t)(t=>t.currentSiteId);return(0,i.a)({queryKey:["admin","points",t],queryFn:()=>(0,o.S)("/points/history?siteId=".concat(t)),enabled:!!t})}function y(){let t=(0,s.NL)(),e=(0,a.t)(t=>t.currentSiteId);return(0,r.D)({mutationFn:t=>{let{memberId:n,amount:i,reason:s}=t;return(0,o.S)("/points/award",{method:"POST",body:JSON.stringify({siteId:e,memberId:n,amount:i,reason:s})})},onSuccess:()=>{t.invalidateQueries({queryKey:["admin","points"]}),t.invalidateQueries({queryKey:["admin","members"]})}})}function p(){let t=(0,a.t)(t=>t.currentSiteId);return(0,i.a)({queryKey:["admin","announcements",t],queryFn:()=>(0,o.S)("/announcements?siteId=".concat(t)),enabled:!!t})}function E(){let t=(0,s.NL)(),e=(0,a.t)(t=>t.currentSiteId);return(0,r.D)({mutationFn:t=>{let{title:n,content:i,isPinned:s}=t;return(0,o.S)("/announcements",{method:"POST",body:JSON.stringify({siteId:e,title:n,content:i,isPinned:s})})},onSuccess:()=>{t.invalidateQueries({queryKey:["admin","announcements"]})}})}function S(){let t=(0,s.NL)();return(0,r.D)({mutationFn:t=>{let{id:e,title:n,content:i,isPinned:s}=t;return(0,o.S)("/announcements/".concat(e),{method:"PUT",body:JSON.stringify({title:n,content:i,isPinned:s})})},onSuccess:()=>{t.invalidateQueries({queryKey:["admin","announcements"]})}})}function O(){let t=(0,s.NL)();return(0,r.D)({mutationFn:t=>(0,o.S)("/announcements/".concat(t),{method:"DELETE"}),onSuccess:()=>{t.invalidateQueries({queryKey:["admin","announcements"]})}})}function R(){let t=(0,a.t)(t=>t.currentSiteId);return(0,i.a)({queryKey:["admin","audit",t],queryFn:()=>Promise.resolve([]),enabled:!!t})}function b(){return(0,i.a)({queryKey:["admin","my-sites"],queryFn:()=>(0,o.S)("/users/me/memberships")})}function v(t,e){let n=(0,a.t)(t=>t.currentSiteId),s=t||n,r=new URLSearchParams;return s&&r.set("siteId",s),e&&r.set("date",e),(0,i.a)({queryKey:["admin","manual-approvals",s,e],queryFn:()=>(0,o.S)("/admin/manual-approvals?".concat(r.toString())),enabled:!!s})}function I(){let t=(0,s.NL)();return(0,r.D)({mutationFn:t=>(0,o.S)("/admin/manual-approval",{method:"POST",body:JSON.stringify(t)}),onSuccess:(e,n)=>{t.invalidateQueries({queryKey:["admin","manual-approvals",n.siteId]})}})}function N(){let t=(0,a.t)(t=>t.currentSiteId);return(0,i.a)({queryKey:["admin","actions",t],queryFn:()=>(0,o.S)("/actions?siteId=".concat(t)),enabled:!!t})}},5118:function(t,e,n){n.d(e,{S:function(){return o}});var i=n(8144);let s="https://safework2.jclee.me/api";class r extends Error{constructor(t,e,n){super(t),this.status=e,this.code=n,this.name="ApiError"}}async function o(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{tokens:n,logout:o,setTokens:a}=i.t.getState(),u={"Content-Type":"application/json",...e.headers||{}};(null==n?void 0:n.accessToken)&&(u.Authorization="Bearer ".concat(n.accessToken));let c=await fetch("".concat(s).concat(t),{...e,headers:u});if(401===c.status&&(null==n?void 0:n.refreshToken)){let i=await fetch("".concat(s,"/auth/refresh"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:n.refreshToken})});if(i.ok){let n=await i.json();a(n),u.Authorization="Bearer ".concat(n.accessToken),c=await fetch("".concat(s).concat(t),{...e,headers:u})}else throw o(),new r("Session expired",401,"SESSION_EXPIRED")}if(!c.ok){let t=await c.json().catch(()=>({}));throw new r(t.message||"Request failed",c.status,t.code)}return c.json()}},8144:function(t,e,n){n.d(e,{t:function(){return o}});var i=n(8321),s=n(4452),r=n(3212);let o=(0,i.U)()((0,s.tJ)((t,e)=>({user:null,tokens:null,currentSiteId:null,isAdmin:!1,login:(e,n)=>t({user:e,tokens:n,isAdmin:e.role===r.UserRole.SITE_ADMIN||e.role===r.UserRole.SUPER_ADMIN}),logout:()=>t({user:null,tokens:null,currentSiteId:null,isAdmin:!1}),setTokens:e=>t({tokens:e}),setSiteId:e=>t({currentSiteId:e})}),{name:"safetywallet-admin-auth"}))},5363:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},8658:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},8536:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},4602:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},6183:function(t,e,n){var i=Object.create?function(t,e,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(e,n);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,i,s)}:function(t,e,n,i){void 0===i&&(i=n),t[i]=e[n]},s=function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||i(e,t,n)};Object.defineProperty(e,"__esModule",{value:!0}),s(n(4602),e),s(n(3700),e),s(n(6668),e),s(n(5769),e),s(n(2232),e),s(n(1098),e),s(n(8658),e),s(n(8536),e)},1098:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},5769:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},2232:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},6668:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},3700:function(t,e){Object.defineProperty(e,"__esModule",{value:!0})},9633:function(t,e){var n,i,s,r,o,a,u,c,h,l,d,f,m,y,p,E,S,O,R,b;Object.defineProperty(e,"__esModule",{value:!0}),e.RejectReason=e.TaskStatus=e.ReviewAction=e.ActionStatus=e.ReviewStatus=e.Visibility=e.RiskLevel=e.Category=e.MembershipStatus=e.UserRole=void 0,(d=n||(e.UserRole=n={})).WORKER="WORKER",d.SITE_ADMIN="SITE_ADMIN",d.SUPER_ADMIN="SUPER_ADMIN",d.SYSTEM="SYSTEM",(f=i||(e.MembershipStatus=i={})).PENDING="PENDING",f.ACTIVE="ACTIVE",f.LEFT="LEFT",f.REMOVED="REMOVED",(m=s||(e.Category=s={})).HAZARD="HAZARD",m.UNSAFE_BEHAVIOR="UNSAFE_BEHAVIOR",m.INCONVENIENCE="INCONVENIENCE",m.SUGGESTION="SUGGESTION",m.BEST_PRACTICE="BEST_PRACTICE",(y=r||(e.RiskLevel=r={})).HIGH="HIGH",y.MEDIUM="MEDIUM",y.LOW="LOW",(p=o||(e.Visibility=o={})).WORKER_PUBLIC="WORKER_PUBLIC",p.ADMIN_ONLY="ADMIN_ONLY",(E=a||(e.ReviewStatus=a={})).RECEIVED="RECEIVED",E.IN_REVIEW="IN_REVIEW",E.NEED_INFO="NEED_INFO",E.APPROVED="APPROVED",E.REJECTED="REJECTED",(S=u||(e.ActionStatus=u={})).NONE="NONE",S.REQUIRED="REQUIRED",S.ASSIGNED="ASSIGNED",S.IN_PROGRESS="IN_PROGRESS",S.DONE="DONE",S.REOPENED="REOPENED",(O=c||(e.ReviewAction=c={})).APPROVE="APPROVE",O.REJECT="REJECT",O.REQUEST_MORE="REQUEST_MORE",O.MARK_URGENT="MARK_URGENT",O.ASSIGN="ASSIGN",O.CLOSE="CLOSE",(R=h||(e.TaskStatus=h={})).OPEN="OPEN",R.IN_PROGRESS="IN_PROGRESS",R.DONE="DONE",(b=l||(e.RejectReason=l={})).DUPLICATE="DUPLICATE",b.UNCLEAR_PHOTO="UNCLEAR_PHOTO",b.INSUFFICIENT="INSUFFICIENT",b.FALSE="FALSE",b.IRRELEVANT="IRRELEVANT",b.OTHER="OTHER"},3212:function(t,e,n){var i=Object.create?function(t,e,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(e,n);(!s||("get"in s?!e.__esModule:s.writable||s.configurable))&&(s={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,i,s)}:function(t,e,n,i){void 0===i&&(i=n),t[i]=e[n]},s=function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||i(e,t,n)};Object.defineProperty(e,"__esModule",{value:!0}),s(n(9633),e),s(n(5363),e),s(n(6183),e)},4855:function(t,e,n){n.d(e,{R:function(){return a},m:function(){return o}});var i=n(2906),s=n(5531),r=n(1135),o=class extends s.F{#t;#e;#n;#i;constructor(t){super(),this.#t=t.client,this.mutationId=t.mutationId,this.#n=t.mutationCache,this.#e=[],this.state=t.state||a(),this.setOptions(t.options),this.scheduleGc()}setOptions(t){this.options=t,this.updateGcTime(this.options.gcTime)}get meta(){return this.options.meta}addObserver(t){this.#e.includes(t)||(this.#e.push(t),this.clearGcTimeout(),this.#n.notify({type:"observerAdded",mutation:this,observer:t}))}removeObserver(t){this.#e=this.#e.filter(e=>e!==t),this.scheduleGc(),this.#n.notify({type:"observerRemoved",mutation:this,observer:t})}optionalRemove(){this.#e.length||("pending"===this.state.status?this.scheduleGc():this.#n.remove(this))}continue(){return this.#i?.continue()??this.execute(this.state.variables)}async execute(t){let e=()=>{this.#s({type:"continue"})},n={client:this.#t,meta:this.options.meta,mutationKey:this.options.mutationKey};this.#i=(0,r.Mz)({fn:()=>this.options.mutationFn?this.options.mutationFn(t,n):Promise.reject(Error("No mutationFn found")),onFail:(t,e)=>{this.#s({type:"failed",failureCount:t,error:e})},onPause:()=>{this.#s({type:"pause"})},onContinue:e,retry:this.options.retry??0,retryDelay:this.options.retryDelay,networkMode:this.options.networkMode,canRun:()=>this.#n.canRun(this)});let i="pending"===this.state.status,s=!this.#i.canStart();try{if(i)e();else{this.#s({type:"pending",variables:t,isPaused:s}),this.#n.config.onMutate&&await this.#n.config.onMutate(t,this,n);let e=await this.options.onMutate?.(t,n);e!==this.state.context&&this.#s({type:"pending",context:e,variables:t,isPaused:s})}let r=await this.#i.start();return await this.#n.config.onSuccess?.(r,t,this.state.context,this,n),await this.options.onSuccess?.(r,t,this.state.context,n),await this.#n.config.onSettled?.(r,null,this.state.variables,this.state.context,this,n),await this.options.onSettled?.(r,null,t,this.state.context,n),this.#s({type:"success",data:r}),r}catch(e){try{await this.#n.config.onError?.(e,t,this.state.context,this,n)}catch(t){Promise.reject(t)}try{await this.options.onError?.(e,t,this.state.context,n)}catch(t){Promise.reject(t)}try{await this.#n.config.onSettled?.(void 0,e,this.state.variables,this.state.context,this,n)}catch(t){Promise.reject(t)}try{await this.options.onSettled?.(void 0,e,t,this.state.context,n)}catch(t){Promise.reject(t)}throw this.#s({type:"error",error:e}),e}finally{this.#n.runNext(this)}}#s(t){this.state=(e=>{switch(t.type){case"failed":return{...e,failureCount:t.failureCount,failureReason:t.error};case"pause":return{...e,isPaused:!0};case"continue":return{...e,isPaused:!1};case"pending":return{...e,context:t.context,data:void 0,failureCount:0,failureReason:null,error:null,isPaused:t.isPaused,status:"pending",variables:t.variables,submittedAt:Date.now()};case"success":return{...e,data:t.data,failureCount:0,failureReason:null,error:null,status:"success",isPaused:!1};case"error":return{...e,data:void 0,error:t.error,failureCount:e.failureCount+1,failureReason:t.error,isPaused:!1,status:"error"}}})(this.state),i.Vr.batch(()=>{this.#e.forEach(e=>{e.onMutationUpdate(t)}),this.#n.notify({mutation:this,type:"updated",action:t})})}};function a(){return{context:void 0,data:void 0,error:null,failureCount:0,failureReason:null,isPaused:!1,status:"idle",variables:void 0,submittedAt:0}}},5969:function(t,e,n){n.d(e,{D:function(){return h}});var i=n(7653),s=n(4855),r=n(2906),o=n(4559),a=n(803),u=class extends o.l{#t;#r=void 0;#o;#a;constructor(t,e){super(),this.#t=t,this.setOptions(e),this.bindMethods(),this.#u()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(t){let e=this.options;this.options=this.#t.defaultMutationOptions(t),(0,a.VS)(this.options,e)||this.#t.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#o,observer:this}),e?.mutationKey&&this.options.mutationKey&&(0,a.Ym)(e.mutationKey)!==(0,a.Ym)(this.options.mutationKey)?this.reset():this.#o?.state.status==="pending"&&this.#o.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#o?.removeObserver(this)}onMutationUpdate(t){this.#u(),this.#c(t)}getCurrentResult(){return this.#r}reset(){this.#o?.removeObserver(this),this.#o=void 0,this.#u(),this.#c()}mutate(t,e){return this.#a=e,this.#o?.removeObserver(this),this.#o=this.#t.getMutationCache().build(this.#t,this.options),this.#o.addObserver(this),this.#o.execute(t)}#u(){let t=this.#o?.state??(0,s.R)();this.#r={...t,isPending:"pending"===t.status,isSuccess:"success"===t.status,isError:"error"===t.status,isIdle:"idle"===t.status,mutate:this.mutate,reset:this.reset}}#c(t){r.Vr.batch(()=>{if(this.#a&&this.hasListeners()){let e=this.#r.variables,n=this.#r.context,i={client:this.#t,meta:this.options.meta,mutationKey:this.options.mutationKey};if(t?.type==="success"){try{this.#a.onSuccess?.(t.data,e,n,i)}catch(t){Promise.reject(t)}try{this.#a.onSettled?.(t.data,null,e,n,i)}catch(t){Promise.reject(t)}}else if(t?.type==="error"){try{this.#a.onError?.(t.error,e,n,i)}catch(t){Promise.reject(t)}try{this.#a.onSettled?.(void 0,t.error,e,n,i)}catch(t){Promise.reject(t)}}}this.listeners.forEach(t=>{t(this.#r)})})}},c=n(7930);function h(t,e){let n=(0,c.NL)(e),[s]=i.useState(()=>new u(n,t));i.useEffect(()=>{s.setOptions(t)},[s,t]);let o=i.useSyncExternalStore(i.useCallback(t=>s.subscribe(r.Vr.batchCalls(t)),[s]),()=>s.getCurrentResult(),()=>s.getCurrentResult()),h=i.useCallback((t,e)=>{s.mutate(t,e).catch(a.ZT)},[s]);if(o.error&&(0,a.L3)(s.options.throwOnError,[o.error]))throw o.error;return{...o,mutate:h,mutateAsync:o.mutate}}}}]);